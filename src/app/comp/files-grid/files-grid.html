<div class="files-grid-viewport">
  <!-- screen loader -->
  <div *ngIf="isScreenLoading" class="fixed inset-0 z-50 bg-black/30 backdrop-blur-sm flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 px-5 py-4 flex items-center gap-3">
      <svg class="w-5 h-5 animate-spin text-sky-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
      <span class="text-sm text-gray-800">Preparing download…</span>
    </div>
  </div>

  <!-- toolbar -->
  <div class="sticky top-2 z-10 bg-white/80 backdrop-blur rounded-xl shadow border border-gray-200 p-4 m-2">
    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div class="flex items-center gap-3">
        <button (click)="downloadAll()" [disabled]="!rowData.length || isDownloadingAll" class="amplify-button amplify-button--primary">
          {{ isDownloadingAll ? 'Preparing…' : 'Download All' }}
        </button>
        <a *ngIf="downloadAllUrl && !actionError" [href]="downloadAllUrl" target="_blank" rel="noopener" class="text-sm text-blue-600 underline">
          Or click here
        </a>
        <!-- <span class="hidden md:inline-block text-xs px-2 py-1 rounded-full bg-slate-50 text-slate-700 border border-slate-200">Rows: {{ rowData?.length || 0 }}</span> -->
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <div class="relative">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35M10 18a8 8 0 100-16 8 8 0 000 16z"/></svg>
          <input type="text" placeholder="Quick search..." [value]="quickFilterText" (input)="onQuickFilterChange($event)" class="pl-9 pr-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-sky-300" />
        </div>
        <button (click)="clearAllFilters()" class="amplify-button">Clear All</button>
      </div>
    </div>
  </div>

  <!-- messages -->
  <div *ngIf="loadError" class="msg msg-error">{{ loadError }}</div>
  <div *ngIf="actionError" class="msg msg-error">{{ actionError }}</div>

  <!-- grid -->
  <ag-grid-angular
    class="ag-theme-quartz"
    style="width:100%; max-width:1100px; height:520px;"
    [theme]="'legacy'"
    [components]="components"
    [context]="context"
    [defaultColDef]="defaultColDef"
    [rowData]="rowData"
    [columnDefs]="columnDefs"
    [quickFilterText]="quickFilterText"
    [pagination]="true"
    [paginationPageSize]="pageSize"
    [paginationPageSizeSelector]="pageSizeOptions"
    (gridReady)="onGridReady($event)"
    (cellClicked)="onCellClicked($event)"
    [enableCellTextSelection]="true">
  </ag-grid-angular>

  <!-- popup -->
  <div *ngIf="showPopup" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 w-full max-w-3xl relative" style="height: 600px; display: flex; flex-direction: column;">
      <button (click)="closePopup()" class="absolute top-2 right-2 text-gray-500 hover:text-black" title="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
      <h2 class="text-lg font-semibold mb-3">Files for selected row</h2>
      <div class="flex gap-2 mb-3 items-center">
        <label class="text-sm">From</label>
        <input type="time" step="1" [(ngModel)]="popupTimeFrom" class="px-2 py-1 rounded border border-gray-300" />
        <label class="text-sm">To</label>
        <input type="time" step="1" [(ngModel)]="popupTimeTo" class="px-2 py-1 rounded border border-gray-300" />
        <button (click)="popupTimeFrom='';popupTimeTo=''" class="amplify-button">Clear</button>
      </div>
      <div style="flex: 1 1 auto; overflow-y: auto;">
        <table class="w-full text-sm border">
          <thead>
            <tr>
              <th class="border px-2 py-1">Time</th>
              <th class="border px-2 py-1">Filename</th>
              <th class="border px-2 py-1">Shimmer Device</th>
              <th class="border px-2 py-1">Shimmer Day</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let f of filteredPopupFiles">
              <td class="border px-2 py-1">{{ f.time }}</td>
              <td class="border px-2 py-1">{{ f.fullname }}</td>
              <td class="border px-2 py-1">{{ f.shimmer_device }}</td>
              <td class="border px-2 py-1">{{ f.shimmer_day }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
